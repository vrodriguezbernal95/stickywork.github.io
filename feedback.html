<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu opini√≥n nos importa - StickyWork</title>
    <link rel="icon" type="image/x-icon" href="assets/logo.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .feedback-container {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .feedback-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .feedback-header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .feedback-header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .feedback-content {
            padding: 40px 30px;
        }

        .booking-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .booking-info h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .booking-info p {
            color: #666;
            margin: 5px 0;
        }

        .question-group {
            margin-bottom: 30px;
        }

        .question-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .required-indicator {
            color: #ef4444;
            margin-left: 4px;
        }

        /* Rating stars */
        .rating-stars {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 10px 0;
        }

        .star {
            font-size: 40px;
            cursor: pointer;
            transition: all 0.2s;
            color: #ddd;
        }

        .star:hover,
        .star.selected {
            color: #fbbf24;
            transform: scale(1.1);
        }

        /* Multiple choice */
        .options-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-item {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option-item.selected {
            border-color: #667eea;
            background: #e0e7ff;
        }

        .option-item input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Text input */
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-family: inherit;
            font-size: 15px;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #dc2626;
            margin-bottom: 20px;
        }

        .success-message {
            text-align: center;
            padding: 40px;
        }

        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .success-message h2 {
            color: #10b981;
            margin-bottom: 10px;
        }

        .success-message p {
            color: #666;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="feedback-container">
        <div class="feedback-header">
            <h1>‚≠ê Tu opini√≥n nos importa</h1>
            <p>Ay√∫danos a mejorar nuestro servicio</p>
        </div>

        <div class="feedback-content" id="feedback-content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Cargando formulario...</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://stickywork-api-production.up.railway.app';
        let bookingData = null;
        let feedbackSettings = null;
        let selectedAnswers = {};

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            showError('Token inv√°lido. Por favor, usa el enlace del email.');
        } else {
            loadFeedbackForm();
        }

        async function loadFeedbackForm() {
            try {
                // Verify token and get booking info
                const response = await fetch(`${API_URL}/api/feedback/verify/${token}`);
                const data = await response.json();

                if (!data.success) {
                    if (data.alreadySubmitted) {
                        showAlreadySubmitted();
                    } else {
                        showError(data.error || 'Token inv√°lido');
                    }
                    return;
                }

                bookingData = data.data.booking;

                // Get business settings (feedback questions)
                const businessResponse = await fetch(`${API_URL}/api/widget/${bookingData.business_id}`);
                const businessData = await businessResponse.json();

                feedbackSettings = businessData.data.bookingSettings?.feedbackSettings || getDefaultFeedbackSettings();

                // Render form
                renderFeedbackForm();

            } catch (error) {
                console.error('Error loading feedback form:', error);
                showError('Error al cargar el formulario. Por favor, int√©ntalo de nuevo m√°s tarde.');
            }
        }

        function getDefaultFeedbackSettings() {
            return {
                enabled: true,
                questions: [
                    {
                        id: 1,
                        type: 'rating',
                        question: '¬øC√≥mo calificar√≠as nuestro servicio?',
                        required: true
                    },
                    {
                        id: 2,
                        type: 'text',
                        question: '¬øQu√© podr√≠amos mejorar?',
                        required: false
                    }
                ]
            };
        }

        function renderFeedbackForm() {
            const content = document.getElementById('feedback-content');

            content.innerHTML = `
                <div class="booking-info">
                    <h3>Detalles de tu reserva</h3>
                    <p><strong>Negocio:</strong> ${bookingData.business_name}</p>
                    ${bookingData.service_name ? `<p><strong>Servicio:</strong> ${bookingData.service_name}</p>` : ''}
                    <p><strong>Fecha:</strong> ${new Date(bookingData.booking_date).toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}</p>
                    <p><strong>Cliente:</strong> ${bookingData.customer_name}</p>
                </div>

                <form id="feedback-form">
                    ${feedbackSettings.questions.map((q, index) => renderQuestion(q, index)).join('')}

                    <!-- Generic question -->
                    <div class="question-group">
                        <label>
                            üí¨ ¬øHay algo m√°s que quieras compartir con nosotros?
                        </label>
                        <textarea
                            id="generic-comment"
                            placeholder="Tu opini√≥n nos ayuda a seguir mejorando..."
                            rows="4"
                        ></textarea>
                    </div>

                    <button type="submit" class="submit-button">
                        Enviar mi opini√≥n
                    </button>
                </form>
            `;

            // Add event listeners
            document.getElementById('feedback-form').addEventListener('submit', handleSubmit);

            // Add click handlers for rating stars
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    const questionId = this.dataset.questionId;
                    const rating = parseInt(this.dataset.rating);

                    selectedAnswers[`q${questionId}`] = rating;

                    // Update star selection
                    const allStars = document.querySelectorAll(`.star[data-question-id="${questionId}"]`);
                    allStars.forEach(s => {
                        const starRating = parseInt(s.dataset.rating);
                        if (starRating <= rating) {
                            s.classList.add('selected');
                        } else {
                            s.classList.remove('selected');
                        }
                    });
                });
            });

            // Add click handlers for multiple choice
            document.querySelectorAll('.option-item').forEach(item => {
                item.addEventListener('click', function() {
                    const questionId = this.dataset.questionId;
                    const value = this.dataset.value;

                    // Deselect all options for this question
                    document.querySelectorAll(`.option-item[data-question-id="${questionId}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });

                    // Select this option
                    this.classList.add('selected');
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) radio.checked = true;

                    selectedAnswers[`q${questionId}`] = value;
                });
            });
        }

        function renderQuestion(question, index) {
            const questionId = question.id || index + 1;
            const required = question.required ? '<span class="required-indicator">*</span>' : '';

            switch (question.type) {
                case 'rating':
                    return `
                        <div class="question-group">
                            <label>
                                ${question.question}${required}
                            </label>
                            <div class="rating-stars">
                                ${[1, 2, 3, 4, 5].map(rating => `
                                    <span class="star" data-question-id="${questionId}" data-rating="${rating}">‚≠ê</span>
                                `).join('')}
                            </div>
                        </div>
                    `;

                case 'multiple_choice':
                    return `
                        <div class="question-group">
                            <label>
                                ${question.question}${required}
                            </label>
                            <div class="options-list">
                                ${(question.options || []).map((option, optIndex) => `
                                    <div class="option-item" data-question-id="${questionId}" data-value="${option}">
                                        <input type="radio" name="q${questionId}" value="${option}" id="q${questionId}_opt${optIndex}">
                                        <label for="q${questionId}_opt${optIndex}" style="cursor: pointer; flex: 1; margin: 0;">
                                            ${option}
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;

                case 'text':
                    return `
                        <div class="question-group">
                            <label>
                                ${question.question}${required}
                            </label>
                            <textarea
                                id="q${questionId}"
                                data-question-id="${questionId}"
                                data-required="${question.required}"
                                placeholder="Escribe tu respuesta aqu√≠..."
                                rows="3"
                            ></textarea>
                        </div>
                    `;

                default:
                    return '';
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();

            // Collect all answers
            const answers = {};

            // Collect answers from rendered questions
            feedbackSettings.questions.forEach((q, index) => {
                const questionId = q.id || index + 1;

                if (q.type === 'rating') {
                    answers[`q${questionId}`] = selectedAnswers[`q${questionId}`] || null;
                } else if (q.type === 'multiple_choice') {
                    answers[`q${questionId}`] = selectedAnswers[`q${questionId}`] || null;
                } else if (q.type === 'text') {
                    const textarea = document.getElementById(`q${questionId}`);
                    answers[`q${questionId}`] = textarea ? textarea.value.trim() : '';
                }

                // Validate required questions
                if (q.required && !answers[`q${questionId}`]) {
                    alert(`Por favor, responde la pregunta: "${q.question}"`);
                    throw new Error('Required question not answered');
                }
            });

            // Generic comment
            const genericComment = document.getElementById('generic-comment').value.trim();

            // Find the first rating question for the main rating
            const mainRatingQuestion = feedbackSettings.questions.find(q => q.type === 'rating');
            const mainRating = mainRatingQuestion ? selectedAnswers[`q${mainRatingQuestion.id}`] : 5;

            if (!mainRating) {
                alert('Por favor, selecciona una calificaci√≥n');
                return;
            }

            // Prepare payload
            const payload = {
                token,
                rating: mainRating,
                comment: genericComment || null,
                questions: answers
            };

            // Disable submit button
            const submitButton = document.querySelector('.submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            try {
                const response = await fetch(`${API_URL}/api/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess();
                } else {
                    showError(data.error || 'Error al enviar tu opini√≥n');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar mi opini√≥n';
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showError('Error de conexi√≥n. Por favor, int√©ntalo de nuevo.');
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar mi opini√≥n';
            }
        }

        function showError(message) {
            document.getElementById('feedback-content').innerHTML = `
                <div class="error-message">
                    <strong>‚ö†Ô∏è Error:</strong> ${message}
                </div>
            `;
        }

        function showSuccess() {
            document.getElementById('feedback-content').innerHTML = `
                <div class="success-message">
                    <div class="success-icon">üéâ</div>
                    <h2>¬°Gracias por tu opini√≥n!</h2>
                    <p>Tu feedback ha sido registrado exitosamente y nos ayudar√° a mejorar nuestro servicio.</p>
                </div>
            `;
        }

        function showAlreadySubmitted() {
            document.getElementById('feedback-content').innerHTML = `
                <div class="success-message">
                    <div class="success-icon">‚úÖ</div>
                    <h2>Ya enviaste tu opini√≥n</h2>
                    <p>Gracias por tu tiempo. Ya hemos recibido tu feedback para esta reserva.</p>
                </div>
            `;
        }
    </script>
</body>
</html>
